
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="UPDATE see this for simpler, cleaner, better directions.I needed a way to program the XMEGA100 breakout board from Sparkfun, and didn’t have a “real programmer”.">
    <meta name="author" content="David Konsumer">
    <title>Turning a Teensy++ 2 into a full AVRISP-MKII clone - Drunken Coder Blog</title>
    <link rel="alternate" href="http://blog.jetboystudio.com/feed.xml" type="application/rss+xml" title="you can do it well, even if you&#x27;re drunk">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/7.4/styles/tomorrow.min.css">
    <meta property="og:site_name" content="Drunken Coder Blog"/>
    <meta property="og:description" content="UPDATE see this for simpler, cleaner, better directions.I needed a way to program the XMEGA100 breakout board from Sparkfun, and didn’t have a “real programmer”.">
    <meta property="og:image" content="http://blog.jetboystudio.com/favicon.ico"/>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>
    <div class="page-article" id="wrap">
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/"><img width="20" height="20" src="/favicon.ico"> Drunken Coder Blog</a>
          </div>
          <div class="collapse navbar-collapse">
            <ul class="nav navbar-nav addthis_toolbox addthis_default_style addthis_32x32_style">
              <li><a href="/">Home</a></li>
              <li><a href="/archive.html">Archive</a></li>
            </ul>
            <ul class="social addthis_toolbox addthis_default_style addthis_32x32_style">
              <li><a class="addthis_button_facebook"></a></li>
              <li><a class="addthis_button_twitter"></a></li>
              <li><a class="addthis_button_google_plusone_share"></a></li>
              <li><a class="addthis_button_compact"></a><a class="addthis_counter addthis_bubble_style"></a></li>
            </ul>
          </div>
        </div>
      </div>

      <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=xa-52a4a9a2159a1d9a"></script>

      <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

      <div class="container">
        <div class="page-header">
          <h2><a href="/articles/teensy2AVRISP-MKII/">Turning a Teensy++ 2 into a full AVRISP-MKII clone</a></h2>
          
          <ul class="tags"> <li>electronics</li>  <li>micro-controllers</li>  <li>Arduino</li>  <li>XMEGA</li>  <li>LUFA</li>  <li>teensy</li> </ul>
          <div class="date">Feb 8th, 2013</div>
        </div>
        <div><p><em>UPDATE</em> see <a href="/articles/teensy2AVRISP-MKII-lufa/">this</a> for simpler, cleaner, better directions.</p>
<p>I needed a way to program the <a href="https://www.sparkfun.com/products/9546">XMEGA100 breakout board from Sparkfun</a>, and didn’t have a “real programmer”.</p>
<hr>
<p>I currently use ArduinoISP running on a bare ATMEGA328 chip to program other ATMEGA chips, and it works great. If you buy a <a href="http://www.atmel.com/tools/AVRISPMKII.aspx">AVRISP-MKII</a>, it can do the same stuff, but also a special protocol (PDI) that the XMEGA board speaks, and TSI for small ATINY chips.</p>
<p>I want to just get started with my project, and not have to wait for shipping, plus I have a lot of stuff around the house like microcontrollers &amp; dev boards, and don;t want to buy something for such a specialized purpose. Surely, there must be something I could put together.</p>
<p>I found <a href="https://github.com/clockfort/Teensy-AVRISP-MKII">this</a> and I happen to have a Teensy++ 2 around, so I figured I was all set.  Had a look at the projects Makefile, and set paths up to use Arduino avr-gcc, etc.  Ran <code>make</code>, and got this error:</p>
<pre><code>Lib/V2ProtocolParams.o: In function `V2Params_SetParameterValue&#39;:
/Users/konsumer/Documents/Projects/Teensy-AVRISP-MKII/Lib/V2ProtocolParams.c:166: undefined reference to `eeprom_update_byte&#39;
collect2: ld returned 1 exit status
make: *** [AVRISP-MKII.elf] Error 1</code></pre>
<p>o dear!</p>
<p>My first thought was maybe something was bad with Arduino version of avr-gcc toolset. I installed the excellent <a href="http://www.obdev.at/products/crosspack/index.html">CrossPack-AVR</a> and restored the Makefile to pristine state. Closed my shell, and re-opened, ensured avr-gcc was in my path, and ran <code>make</code>.</p>
<p>Hmm… Same deal.</p>
<p>I started googling and found <a href="https://groups.google.com/forum/#!msg/lufa-support/hp_R8QwHxH4/5UdPMbsjrmEJ">this</a>. I have a sweet-ass Win7 VirtualBox, so I can install the newest WinAVR and be happy.</p>
<p>And that is what I did. Installed WinAVR, ran make, and got same error!</p>
<p>Ack. <a href="http://www.youtube.com/watch?v=7nrCvjg6nsI">Hulk starting to get angry</a>!</p>
<p>Better check windows version of avr-gcc</p>
<pre><code>E:\Documents\Projects\Teensy-AVRISP-MKII&gt;avr-gcc --version
avr-gcc (WinAVR 20100110) 4.3.3
Copyright (C) 2008 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</code></pre>
<p>Closed my Virtualbox in a wild fit of personal rage when I did this on my Mac:</p>
<pre><code>avr-gcc --version
avr-gcc (GCC) 4.6.2
Copyright (C) 2011 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</code></pre>
<p>It’s a newer version!  Hmm.  Maybe I should return to <a href="https://groups.google.com/forum/#!searchin/lufa-support/shift$20count$20%3E=$20width$20of$20type/lufa-support/-aKtGElksQU/59NrmU-yrYYJ">tha googlings</a>.</p>
<p>I opened the makefile, and did a search for “linker”, and found this section:</p>
<pre><code class="lang-makefile"><span class="comment">#---------------- Linker Options ----------------</span>
<span class="comment">#  -Wl,...:     tell GCC to pass this to linker.</span>
<span class="comment">#    -Map:      create map file</span>
<span class="comment">#    --cref:    add cross reference to  map file</span>
<span class="constant">LDFLAGS</span>  = -Wl,-Map=<span class="variable">$(TARGET)</span>.map,--cref
<span class="constant">LDFLAGS</span> += -Wl,--relax 
<span class="constant">LDFLAGS</span> += -Wl,--gc-sections
<span class="constant">LDFLAGS</span> += <span class="variable">$(EXTMEMOPTS)</span>
<span class="constant">LDFLAGS</span> += <span class="variable">$(patsubst %,-L%,$(EXTRALIBDIRS)</span>)
<span class="constant">LDFLAGS</span> += <span class="variable">$(PRINTF_LIB)</span> <span class="variable">$(SCANF_LIB)</span> <span class="variable">$(MATH_LIB)</span>
<span class="comment">#LDFLAGS += -T linker_script.x</span></code></pre>
<p>Added a line that looked like this after it:</p>
<pre><code class="lang-makefile"><span class="constant">LDFLAGS</span> += -lavr51/libc.a</code></pre>
<p>Hmm, after make, now I get</p>
<pre><code>Descriptors.c: At top level:
Descriptors.c:45:33: error: variable &#39;DeviceDescriptor&#39; must be const in order to be put into read-only section by means of &#39;__attribute__((progmem))&#39;
Descriptors.c:72:40: error: variable &#39;ConfigurationDescriptor&#39; must be const in order to be put into read-only section by means of &#39;__attribute__((progmem))&#39;
Descriptors.c:130:33: error: variable &#39;LanguageString&#39; must be const in order to be put into read-only section by means of &#39;__attribute__((progmem))&#39;
Descriptors.c:141:33: error: variable &#39;ManufacturerString&#39; must be const in order to be put into read-only section by means of &#39;__attribute__((progmem))&#39;
Descriptors.c:152:33: error: variable &#39;ProductString&#39; must be const in order to be put into read-only section by means of &#39;__attribute__((progmem))&#39;
Descriptors.c:162:33: error: variable &#39;SerialString&#39; must be const in order to be put into read-only section by means of &#39;__attribute__((progmem))&#39;
make: *** [Descriptors.o] Error 1</code></pre>
<p>Changed everything back to pristine, same prob, without <code>avr51/libc.a</code> stuff. Wtf? Must have been something incomplete with my install. <a href="http://www.youtube.com/watch?v=7nrCvjg6nsI">Hulk starting to get angry, again</a>!</p>
<p>Found <a href="http://arduino.cc/forum/index.php/topic,66710.0.html">this</a> and thought maybe I should double check types. Added <code>const</code> to code on Descriptors.c which had PROGMEM. Got to next file Lib/ISP/ISPTarget.c, did same.  Whoah!  It built.</p>
<p>Fired up <a href="http://www.pjrc.com/teensy/loader_mac.html">Ye olde teensy loader</a> and burnt that shit.</p>
<p>Unplugged it, and plugged it in. Open “System Report” (apple/about this mac/more info) and this what it had to say:</p>
<pre><code>LUFA AVRISP MkII Clone:

  Product ID:    0x2104
  Vendor ID:    0x03eb  (Atmel Corporation)
  Version:     2.00
  Serial Number:    0000A00128255
  Speed:    Up to 12 Mb/sec
  Manufacturer:    Dean Camera
  Location ID:    0x1d110000 / 7
  Current Available (mA):    500
  Current Required (mA):    Unknown (Device has not been configured)</code></pre>
<p>Dang! So happy. <a href="http://www.youtube.com/watch?v=VazV36eWHLc">Life is rad</a>.</p>
<p>If you want the hex for your own Teensy++ 2, <a href="/articles/teensy2AVRISP-MKII/teensy_avrisp-mk2.zip">here</a> it is. Now you don’t have to bother with all this silly bizness.</p>
<p>Looks like I may need to do something with that ‘Unknown (Device has not been configured)’ bit. dunno.</p>
</div>
        
      </div>
      
      <div class="container" id="disqus_thread"></div>
      <script type="text/javascript">
          var disqus_shortname = 'jetboystudio';
          var ga_code = 'UA-2392079-5';
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();

        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-2392079-5', 'jetboystudio.com');
        ga('send', 'pageview');
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    </div> <!-- /#wrap -->

    <div id="footer">
      <div class="container">
        <p class="text-muted credit">© 2014 David Konsumer</p>
      </div>
    </div>

    <script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.2/js/bootstrap.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/7.4/highlight.min.js"></script>

  </body>
</html>



